<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
    <meta name="microid" content="ff511e16d7108be450fccd6f4611cf8d1d5416d1" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta charset="utf-8">
<link rel="icon" href="/images/favicon.gif" />
<link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/DeferredUntilInspirationHits" />
<link rel="stylesheet" href="/stylesheets/reset.css" type="text/css" media="all" />
<link rel="stylesheet" href="/stylesheets/congobongo.css" type="text/css" media="all" />
<link rel="openid.server" href="http://www.myopenid.com/server" />
<link rel="openid.delegate" href="http://chrisroos.myopenid.com/" />
<title>CruiseControlrb With Passenger and Launchd on a Mac - Chris Roos</title>


    
      
        <link rel="prev" href="/blog/2009-03-30-installing-passenger-2-1-2-on-centos-5-2" />
      
      
        <link rel="next" href="/blog/2009-04-14-generating-and-inserting-a-rel=canonical-link-into-pages-with-firefox-and-greasemonkey" />
      
      <link rel="first" href="/blog/2005-09-06-linspire" />
      <link rel="last" href="/blog/2015-11-20-confusing-git-log-behaviour" />
      <link rel="index" href="/blog" />
      
        <meta name="description" content="Getting CruiseControl.rb running under Passenger (mod_rails) with the builders being started automatically via launchd (on a Mac)." />
      
    
  <body>
    <div id="page">
      <div id="header" class="group">
        <p id="site_name">
  <a href="/">chris roos</a>
</p>

        <ul class="navigation group">
  <li>
    <a href="/about" title="About me">about me</a>
  </li>
  <li>
    <a href="/contact" title="Contact me">contact me</a>
  </li>
  <li>
    <a href="/blog" title="Blog">blog</a>
  </li>
  <li>
    <a href="/projects" title="Projects">projects</a>
  </li>
  <li>
    <a href="/utilities" title="Utilities">utilities</a>
  </li>
</ul>

        <form id="searchForm" action="http://www.google.co.uk/search">
  <div>
    <input type="hidden" name="q" value="site:chrisroos.co.uk" />
    <input type="text" name="q" size="31" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>

      </div>
      <div id="content">
        <abbr class="createdAt" title="2009-03-31T18:27:25+01:00">Tue, 31 Mar 09</abbr>
        <h1>CruiseControlrb With Passenger and Launchd on a Mac</h1>
        <p>This has taken me ages, is quite fiddly and I’m still not 100% happy
with it but it seems to work well enough to document here.</p>

<h2>Configuring the server to run under Passenger</h2>

<ul>
  <li>Buy a Mac. Hmm, maybe that’s starting a little too early in the
process…</li>
</ul>

<!-- -->

<ul>
  <li>Install <a href="http://www.modrails.com/">Passenger</a>.</li>
</ul>

<!-- -->

<ul>
  <li>Download
<a href="http://cruisecontrolrb.thoughtworks.com/">cruisecontrol.rb</a> (from
<a href="http://github.com/thoughtworks/cruisecontrol.rb/tree/master">github</a>
or <a href="http://rubyforge.org/projects/cruisecontrolrb/">rubyforge</a>).
We’re using the version from <a href="http://github.com/">github</a> as it has
<a href="http://git-scm.com/">git</a> support built in.</li>
</ul>

<!-- -->

<ul>
  <li>Edit the cruisecontrol.rb production environment
(cc.rb/config/environments/production.rb) so that we can disable the
builders by setting an environment variable. By default, starting
the server (even through Passenger) starts the builders too. This
doesn’t work by default because the PATH environment variable isn’t
set which means the builders can’t find git. Although it doesn’t
feel like entirely the right approach I actually wonder if I could
use the ruby-wrapper-approach (detailed below) to have these
builders work correctly.</li>
</ul>

<p><code>code
   config.after_initialize do
     require CRUISE_DATA_ROOT + '/site_config' if File.exists?(CRUISE_DATA_ROOT + "/site_config.rb")
     require RAILS_ROOT + '/config/dashboard_initialize'
  -  BuilderStarter.start_builders
  +  BuilderStarter.start_builders unless ENV['CCRB_WITHOUT_BUILDERS']
   end
</code></p>

<ul>
  <li>Create a wrapper around <a href="http://www.ruby-lang.org/">ruby</a> that
allows us to pass environment variables to our Passenger apps. I
actually made the amendment to the code above before realising that
it’s not entirely trivial to pass environment variables from
<a href="http://httpd.apache.org/">Apache</a> to a Passenger app (<a href="http://code.google.com/p/phusion-passenger/issues/detail?id=81">this
ticket</a>
details the problem). I wasn’t keen on the idea of this wrapper
(<a href="http://blog.phusion.nl/2008/12/16/passing-environment-variables-to-ruby-from-phusion-passenger/">explanation on the phusion
blog</a>)
at first but I ended up thinking it was the neatest solution.</li>
</ul>

<p>``` code
  $ cat &gt; ~/ruby_for_passenger
  #!/bin/sh</p>

<p>export CCRB_WITHOUT_BUILDERS=true</p>

<p>exec “/usr/bin/ruby” “$@”</p>

<p>$ sudo mv ~/ruby_for_passenger /usr/local/bin/
  $ sudo chmod +x /usr/local/bin/ruby_for_passenger
```</p>

<ul>
  <li>Change the value of the PassengerRuby configuration option in your
apache httpd config. We need to tell Passenger to use our wrapper
script instead of the default ruby binary it found during
installation.</li>
</ul>

<p><code>code
  $ sudo vi /etc/apache2/httpd.conf
  #PassengerRuby /System/Library/Frameworks/Ruby.framework/Versions/1.8/usr/bin/ruby
  PassengerRuby /usr/local/bin/ruby_for_passenger
</code></p>

<ul>
  <li>Configure the passenger virtual host for your cruise instance. I
strongly recommend using the <a href="http://www.fngtps.com/passenger-preference-pane">Passenger preference
pane</a> to do this
(remember to set it to use the production environment).</li>
</ul>

<!-- -->

<ul>
  <li>Navigate to your chosen local domain and you should be presented
with the default cruise web interface.</li>
</ul>

<h2>Configuring the builders to start under launchd</h2>

<ul>
  <li>Edit the cc.rb/script/builder file to set the default log directory
to a path relative to the project root. This is so that we can run
the builders from a location other than within cc.rb and still have
them log correctly (the default behaviour is that we receive a
warning about a missing log directory and the log output is
redirected to stdout).</li>
</ul>

<p><code>code
  -  CRUISE_OPTIONS[:log_file_name] = "log/#{CRUISE_OPTIONS[:project_name]}_builder.log"
  +  CRUISE_OPTIONS[:log_file_name] = File.join(RAILS_ROOT, 'log', "#{CRUISE_OPTIONS[:project_name]}_builder.log")
</code></p>

<ul>
  <li>Create a <a href="http://en.wikipedia.org/wiki/Launchd">launchd</a> <a href="http://en.wikipedia.org/wiki/Property_list">property
list</a> for each task.
I’ve got mine in \~/Library/LaunchAgents/label-from-plist in the
home directory of a user that has public key access to the git
repository. This is my one annoyance with this current solution: It
requires the user mentioned above to be logged in. I spent a very
long time trying to get the builders working as <a href="http://developer.apple.com/technotes/tn2005/tn2083.html#SECDAEMONS">launch
daemons</a>,
rather than
<a href="http://developer.apple.com/technotes/tn2005/tn2083.html#SECAGENTS">agents</a>,
so that they would build without a user having to be logged in. I
was hoping to find an environment variable I could set so that git
or <a href="http://en.wikipedia.org/wiki/Secure_Shell">SSH</a> knew to use the
public key from a user other than root (who the launch daemons run
as) but didn’t have any such luck. If anyone has any ideas about
this I’d love to hear them. <strong>Note</strong> Although I haven’t tried it, I
suspect that it’d be trivial to get non-public-key subversion
builders to run as daemons.</li>
</ul>

<p>``` code
  <?xml version="1.0" encoding="UTF-8"?>
  &lt;!DOCTYPE plist PUBLIC “-//Apple//DTD PLIST 1.0//EN” “http://www.apple.com/DTDs/PropertyList-1.0.dtd”&gt;
  <plist version="1.0">
    <dict>
      <key>EnvironmentVariables</key>
      <dict>
        <key>PATH</key>
        <string>/usr/bin:/opt/local/bin</string>
      </dict>
      <key>Label</key>
      <string>label-describing-your-builder</string>
      <key>ProgramArguments</key>
      <array>
        <string>/Users/chrisroos/cruisecontrol.rb/cruise</string>
        <string>build</string>
        <string>name-of-project-to-build</string>
      </array>
      <key>RunAtLoad</key>
      <true></true>
    </dict>
  </plist></p>

<p># Notes:
  # We set the PATH environment variable so that both git and ruby can be found.
  # We set RunAtLoad so that as soon as the plist is loaded by launchctl it will start to run.
```</p>

<ul>
  <li>Load the agent using
<a href="http://developer.apple.com/DOCUMENTATION/DARWIN/Reference/ManPages/man1/launchctl.1.html">launchctl</a>
as the user named above (i.e. not root).</li>
</ul>

<p><code>code
  $ launchctl load ~/Library/LaunchAgents/label-from-plist
</code></p>

<p>And that should be about it. I’d appreciate any feedback anyone has
about this approach and to hear about alternative approaches of getting
cruise running automatically on system boot.</p>


        <hr />
        
  <ul class="navigation group">
    
      <li class="previousPost">
        &laquo; (older)
        <a class="previousPost" rel="prev" href="/blog/2009-03-30-installing-passenger-2-1-2-on-centos-5-2" title="Installing Passenger 2.1.2 on CentOS 5.2">
          Installing Passenger 2.1.2 on CentOS 5.2
        </a>
      </li>
    

    
      <li class="nextPost">
        <a class="nextPost" rel="next" href="/blog/2009-04-14-generating-and-inserting-a-rel=canonical-link-into-pages-with-firefox-and-greasemonkey" title="Generating and Inserting a Rel=Canonical Link Into Pages With Firefox and Greasemonkey">
          Generating and Inserting a Rel=Canonical Link Into Pages With Firefox and Greasemonkey
        </a>
        (newer) &raquo;
      </li>
    
  </ul>


      </div>
      <div id="footer">
        <p class="license">
  <a rel="license" href="http://creativecommons.org/licenses/by/2.0/uk/">
    <img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by/2.0/uk/80x15.png" />
  </a>
  <span xmlns:dc="http://purl.org/dc/elements/1.1/" href="http://purl.org/dc/dcmitype/Text" property="dc:title" rel="dc:type">
    deferred until inspiration hits
  </span>
  by
  <span class="vcard">
    <a xmlns:cc="http://creativecommons.org/ns#" href="/contact" property="cc:attributionName" rel="cc:attributionURL" class="url fn">
      Chris Roos
    </a>
  </span>
  is licensed under a
  <a rel="license" href="http://creativecommons.org/licenses/by/2.0/uk/">
    Creative Commons Attribution 2.0 UK: England &amp; Wales License
  </a>
</p>

      </div>
    </div>
    <script src="/javascripts/google-custom-search.js" type="text/javascript" charset="utf-8"></script>
  </body>
</html>
