<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
    <meta name="microid" content="ff511e16d7108be450fccd6f4611cf8d1d5416d1" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta charset="utf-8">
<link rel="icon" href="/images/favicon.gif" />
<link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/DeferredUntilInspirationHits" />
<link rel="stylesheet" href="/stylesheets/reset.css" type="text/css" media="all" />
<link rel="stylesheet" href="/stylesheets/congobongo.css" type="text/css" media="all" />
<link rel="openid.server" href="http://www.myopenid.com/server" />
<link rel="openid.delegate" href="http://chrisroos.myopenid.com/" />
<title>Using in memory Active Record objects with associations for testing - Chris Roos</title>


    
      
        <link rel="prev" href="/blog/2006-07-12-ruby-hashes-with-default-values" />
      
      
        <link rel="next" href="/blog/2006-07-14-textmate-command-to-display-active-record-column-attributes" />
      
      <link rel="first" href="/blog/2005-09-06-linspire" />
      <link rel="last" href="/blog/2015-11-20-confusing-git-log-behaviour" />
      <link rel="index" href="/blog" />
      
    
  <body>
    <div id="page">
      <div id="header" class="group">
        <p id="site_name">
  <a href="/">chris roos</a>
</p>

        <ul class="navigation group">
  <li>
    <a href="/about" title="About me">about me</a>
  </li>
  <li>
    <a href="/contact" title="Contact me">contact me</a>
  </li>
  <li>
    <a href="/blog" title="Blog">blog</a>
  </li>
  <li>
    <a href="/projects" title="Projects">projects</a>
  </li>
  <li>
    <a href="/utilities" title="Utilities">utilities</a>
  </li>
</ul>

        <form id="searchForm" action="http://www.google.co.uk/search">
  <div>
    <input type="hidden" name="q" value="site:chrisroos.co.uk" />
    <input type="text" name="q" size="31" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>

      </div>
      <div id="content">
        <abbr class="createdAt" title="2006-07-12T01:23:00+01:00">Wed, 12 Jul 06</abbr>
        <h1>Using in memory Active Record objects with associations for testing</h1>
        <p>Hitting the database in testing is bad.</p>

<p>Something that I’ve found relatively useful at
<a href="http://www.reevoo.com">work</a> is to use real <a href="http://api.rubyonrails.com/classes/ActiveRecord/Base.html">Active
Record</a>
objects without any persistence (basically use AR#new and not
AR#save[!] or AR#create[!]). When using standard techniques to
create the association objects in memory you only get one side of the
association at a time. Consider the following.</p>

<p>``` code
class Person &lt; ActiveRecord::Base
  has_many :addresses
end
class Address &lt; ActiveRecord::Base
  belongs_to :person
end</p>

<h1>One sided relationship with parent getting access to child</h1>
<p>chris = Person.new
home = chris.addresses.build</p>

<p>chris.addresses.first
=&gt; #<home>
home.person
=&gt; nil</home></p>

<h1>One sided relationship with child getting access to parent</h1>
<p>home = Address.new
chris = home.build_person</p>

<p>chris.addresses
=&gt; []
home.person
=&gt; #<chris></chris></p>

<h1>The example above that creates the address first could also have been written as.</h1>
<p># chris = Person.new
# home = Address.new(:person =&gt; chris)
```</p>

<p>You can see that in each case, only one side of the relationship has
access to the other. If we were persisting the objects then the
relationship would be two way via a database lookup. We can get a two
way relationship in memory; although it has a certain duplication smell
about it. Assuming the same models as above, we can amend the above
examples like so.</p>

<p>``` code
# First example
chris = Person.new
home = chris.addresses.build(:person =&gt; chris)</p>

<p>chris.addresses.first
=&gt; #<home>
home.person
=&gt; #<chris></chris></home></p>

<h1>Second example</h1>
<p>home = Address.new
chris = home.build_person(:addresses =&gt; [home])</p>

<p>home.person
=&gt; #<chris>
chris.addresses.first
=&gt; #<home>
```</home></chris></p>

<p>I’ve occasionally used this in place of stubbing methods but am still
not 100% convinced of the definite benefits one way or another. I do
have some definite disadvantages of stubbing methods (nothing exciting,
they’ve almost certainly been noted by many others in the past) which
I’ll note down at a later date.</p>


        <hr />
        
  <ul class="navigation group">
    
      <li class="previousPost">
        &laquo; (older)
        <a class="previousPost" rel="prev" href="/blog/2006-07-12-ruby-hashes-with-default-values" title="Ruby hashes with default values">
          Ruby hashes with default values
        </a>
      </li>
    

    
      <li class="nextPost">
        <a class="nextPost" rel="next" href="/blog/2006-07-14-textmate-command-to-display-active-record-column-attributes" title="Textmate command to display Active Record column attributes">
          Textmate command to display Active Record column attributes
        </a>
        (newer) &raquo;
      </li>
    
  </ul>


      </div>
      <div id="footer">
        <p class="license">
  <a rel="license" href="http://creativecommons.org/licenses/by/2.0/uk/">
    <img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by/2.0/uk/80x15.png" />
  </a>
  <span xmlns:dc="http://purl.org/dc/elements/1.1/" href="http://purl.org/dc/dcmitype/Text" property="dc:title" rel="dc:type">
    deferred until inspiration hits
  </span>
  by
  <span class="vcard">
    <a xmlns:cc="http://creativecommons.org/ns#" href="/contact" property="cc:attributionName" rel="cc:attributionURL" class="url fn">
      Chris Roos
    </a>
  </span>
  is licensed under a
  <a rel="license" href="http://creativecommons.org/licenses/by/2.0/uk/">
    Creative Commons Attribution 2.0 UK: England &amp; Wales License
  </a>
</p>

      </div>
    </div>
    <script src="/javascripts/google-custom-search.js" type="text/javascript" charset="utf-8"></script>
  </body>
</html>
