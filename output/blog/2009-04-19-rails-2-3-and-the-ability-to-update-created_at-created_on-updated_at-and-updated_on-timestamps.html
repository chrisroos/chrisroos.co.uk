<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta content="ff511e16d7108be450fccd6f4611cf8d1d5416d1" name="microid" />
    <meta content="text/html; charset=utf-8" http-equiv="content-type" />
    <meta charset="utf-8" />
    <link href="/images/favicon.gif" rel="icon" />
    <link href="http://feeds.feedburner.com/DeferredUntilInspirationHits" rel="alternate" title="RSS" type="application/rss+xml" />
    <link href="/stylesheets/reset.css" media="all" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/congobongo.css" media="all" rel="stylesheet" type="text/css" />
    <link href="http://www.myopenid.com/server" rel="openid.server" />
    <link href="http://chrisroos.myopenid.com/" rel="openid.delegate" />
    <title>Rails 2.3 and the ability to update created_at, created_on, updated_at and updated_on timestamps - Chris Roos</title>
    <link href="/blog/2009-04-14-generating-and-inserting-a-rel=canonical-link-into-pages-with-firefox-and-greasemonkey" rel="prev" />
    <link href="/blog/2009-04-24-a-greasemonkey-script-that-inserts-a-google-site-search-form-into-every-page" rel="next" />
    <link href="/blog/2005-09-06-linspire" rel="first" />
    <link href="/blog/2015-11-20-confusing-git-log-behaviour" rel="last" />
    <link href="/blog" rel="index" />
    <meta content="There was a Rails 2.3 security note that suggested we could now set the AR timestamps.  It turns out we've always been able to set the created_at/on timestamps and that updated_at/on are also now assignable." name="description" />
  </head>
  <body>
    <div id="page">
      <div class="group" id="header">
        <p id="site_name">
          <a href="/">chris roos</a>
        </p>
        <ul class="navigation group">
          <li>
            <a href="/about" title="About me">about me</a>
          </li>
          <li>
            <a href="/contact" title="Contact me">contact me</a>
          </li>
          <li>
            <a href="/blog" title="Blog">blog</a>
          </li>
          <li>
            <a href="/projects" title="Projects">projects</a>
          </li>
          <li>
            <a href="/utilities" title="Utilities">utilities</a>
          </li>
        </ul>
        <form action="http://www.google.co.uk/search" id="searchForm">
          <div>
            <input name="q" type="hidden" value="site:chrisroos.co.uk" />
            <input name="q" size="31" type="text" />
            <input name="sa" type="submit" value="Search" />
          </div>
        </form>
      </div>
      <div id="content">
        <abbr class="createdAt" title="2009-04-19T07:39:23+00:00">Sun, 19 Apr 09</abbr>
        <h1>Rails 2.3 and the ability to update created_at, created_on, updated_at and updated_on timestamps</h1>
        <p>The timing of the <a href="http://groups.google.com/group/rubyonrails-security/browse_thread/thread/1d2fb5dc524f9ff4">automatically generated timestamps and attribute assignment in rails 2.3 security note</a> <sup class="footnote" id="fnr1"><a href="#fn1">1</a></sup> was interesting to me because I&#8217;d just spent a while really trying to get my head around <a href="http://api.rubyonrails.org/classes/ActiveRecord/Base.html#M002226">attr_accessible</a> and  <a href="http://api.rubyonrails.org/classes/ActiveRecord/Base.html#M002225">attr_protected</a> and the best way to test their effects in an app I was working on.  Although I intend to write about the testing separately, the conclusion I came to was that I wanted to test the behaviour (more specifically, I was interested in what I could/couldn&#8217;t assign) of my objects and not that I was specifically using attr_accessible or attr_protected.</p>
        <p>Reading Alex&#8217;s post made me wonder whether the <a href="http://rubyonrails.org/">rails</a> <a href="http://en.wikipedia.org/wiki/API"><span class="caps">API</span></a> ever guaranteed that the timestamps would be readonly: If that was the case then I can see arguments for not wanting to test the behaviour of your objects (because you&#8217;re essentially testing the framework itself).  I couldn&#8217;t find any mention of whether they&#8217;d specifically be readonly so chose to do a bit of digging.  I created a <a href="http://chrisroos.googlecode.com/svn/trunk/scratch/rails_timestamps_test/">script</a> that allowed me to, with relative ease, run tests against rails apps created with different versions of rails.  Using this I was able to test the mass assignment of timestamps (created_at, created_on, updated_at and updated_on) against multiple versions of rails.  The conclusion I came to (and I&#8217;d love for other people to replicate my experiment and prove/disprove my results) was that the created_at and created_on pair of attributes have always (at least as far back as rails 1.0.0) been assignable, while the updated_at and updated_on attributes have only recently become assignable.  While digging I managed to find the <a href="https://rails.lighthouseapp.com/projects/8994/tickets/1612-cant-create-ar-models-with-custom-updated_xx-timestamp">lighthouse ticket</a> (#1612) that requested the ability to set the updated_* timestamps and the <a href="http://github.com/rails/rails/commit/63aac338332a06d3c9e28dde7954679703ec7620">rails commit</a> that closed that ticket.</p>
        <h2 id="replicating-my-experiment">Replicating my experiment</h2>
        <ul>
        	<li>Get a copy of rails</li>
        </ul>
        <pre class="code shell">&#x000A;  $ cd /path/to/code&#x000A;  $ git clone git://github.com/rails/rails.git</pre>
        <ul>
        	<li>Create a <a href="http://www.mysql.com/">mysql</a> database called rails_timestamps_test, and create a table within that database called people.</li>
        </ul>
        <pre class="code sql">&#x000A;  mysql&gt; CREATE DATABASE rails_timestamps_test;&#x000A;  mysql&gt; USE rails_timestamps_test;&#x000A;  mysql&gt; CREATE TABLE people (id INTEGER AUTO_INCREMENT, created_on DATE, created_at DATETIME, updated_on DATE, updated_at DATETIME, PRIMARY KEY (id));</pre>
        <ul>
        	<li>Get a copy of my test script</li>
        </ul>
        <pre class="code shell">&#x000A;  $ cd /path/to/code&#x000A;  $ svn co http://chrisroos.googlecode.com/svn/trunk/scratch/rails_timestamps_test</pre>
        <ul>
        	<li>Run my script against rails 2.3 (run setup_rails_project.rb without any arguments to see the options) and hopefully see output similar to below (which means that the tests passed as expected).</li>
        </ul>
        <pre class="code shell">&#x000A;  $ cd /path/to/code/rails_timestamps_test&#x000A;  $ ruby setup_rails_project.rb 2.3.0 /path/to/code/rails&#x000A;&#x000A;  *** Removing the rails app at /path/to/code/rails_timestamps_test/projects/rails-app-2-3-0&#x000A;  *** Checking out the rails version tagged v2.3.0&#x000A;  HEAD is now at beca1f2... Template#mime_type should not use Mime::Type when Action Controller is not included&#x000A;  *** Creating the rails app at /path/to/code/rails_timestamps_test/projects/rails-app-2-3-0&#x000A;  *** Vendorising rails from /path/to/code/rails to /path/to/code/rails_timestamps_test/projects/rails-app-2-3-0&#x000A;  *** Generating rails_version_test.rb in /path/to/code/rails_timestamps_test/projects/rails-app-2-3-0/test/unit to ensure we are testing against the correct version of rails&#x000A;  *** Copying assets to the new rails app&#x000A;  ****** Linking /path/to/code/rails_timestamps_test/assets/person_test.rb to /path/to/code/rails_timestamps_test/projects/rails-app-2-3-0/test/unit/person_test.rb&#x000A;  ****** Linking /path/to/code/rails_timestamps_test/assets/person.rb to /path/to/code/rails_timestamps_test/projects/rails-app-2-3-0/app/models/person.rb&#x000A;  ****** Linking /path/to/code/rails_timestamps_test/assets/database.yml to /path/to/code/rails_timestamps_test/projects/rails-app-2-3-0/config/database.yml&#x000A;  *** Running the rails version test to ensure that we're testing against the correct version of rails&#x000A;  Loaded suite test/unit/rails_version_test&#x000A;  Started&#x000A;  .&#x000A;  Finished in 0.000327 seconds.&#x000A;&#x000A;  1 tests, 1 assertions, 0 failures, 0 errors&#x000A;  *** Running the timestamps test&#x000A;  Loaded suite test/unit/person_test&#x000A;  Started&#x000A;  ....&#x000A;  Finished in 0.078819 seconds.&#x000A;&#x000A;  4 tests, 8 assertions, 0 failures, 0 errors</pre>
        <ul>
        	<li>Re-run the script against rails 2.2.2 (the last tag before 2.3) and you should see the same as above except for the last test which should now contain two failures.</li>
        </ul>
        <pre class="code shell">&#x000A;  $ cd /path/to/code/rails_timestamps_test&#x000A;  $ ruby setup_rails_project.rb 2.2.2 /path/to/code/rails&#x000A;&#x000A;  ... some lines snipped ...&#x000A;  *** Running the timestamps test&#x000A;  Loaded suite test/unit/person_test&#x000A;  Started&#x000A;  ..FF&#x000A;  Finished in 0.069429 seconds.&#x000A;&#x000A;    1) Failure:&#x000A;  test_should_be_able_to_set_updated_at(PersonTest)&#x000A;      [test/unit/person_test.rb:35:in `test_should_be_able_to_set_updated_at'&#x000A;       /path/to/code/rails_timestamps_test/projects/rails-app-2-2-2/vendor/rails/activesupport/lib/active_support/testing/setup_and_teardown.rb:94:in `__send__'&#x000A;       /path/to/code/rails_timestamps_test/projects/rails-app-2-2-2/vendor/rails/activesupport/lib/active_support/testing/setup_and_teardown.rb:94:in `run']:&#x000A;  FAIL: Couldn't persist the mass assigned updated_at attribute.&#x000A;  &lt;Thu Jan 01 00:00:00 +0000 2009&gt; expected but was&#x000A;  &lt;Sun, 19 Apr 2009 09:23:46 UTC +00:00&gt;.&#x000A;&#x000A;    2) Failure:&#x000A;  test_should_be_able_to_set_updated_on(PersonTest)&#x000A;      [test/unit/person_test.rb:28:in `test_should_be_able_to_set_updated_on'&#x000A;       /path/to/code/rails_timestamps_test/projects/rails-app-2-2-2/vendor/rails/activesupport/lib/active_support/testing/setup_and_teardown.rb:94:in `__send__'&#x000A;       /path/to/code/rails_timestamps_test/projects/rails-app-2-2-2/vendor/rails/activesupport/lib/active_support/testing/setup_and_teardown.rb:94:in `run']:&#x000A;  FAIL: Couldn't persist the mass assigned updated_on attribute.&#x000A;  &lt;Thu, 01 Jan 2009&gt; expected but was&#x000A;  &lt;Sun Apr 19 09:23:46 UTC 2009&gt;.&#x000A;&#x000A;  4 tests, 8 assertions, 2 failures, 0 errors</pre>
        <ul>
        	<li>Re-run the script against any other tagged version of rails you wish.</li>
        </ul>
        <h2 id="notes-about-the-script">A couple of notes about the script</h2>
        <ul>
        	<li>If you specify an invalid tag (i.e. a tag that doesn&#8217;t exist in the rails repository) then the rails_version_test.rb will fail.</li>
        </ul>
        <pre class="code shell">&#x000A;  $ cd /path/to/code/rails_timestamps_test&#x000A;  $ ruby setup_rails_project.rb made.up.tag /path/to/code/rails&#x000A;&#x000A;  ... some lines snipped ...&#x000A;  Loaded suite test/unit/rails_version_test&#x000A;  Started&#x000A;  F&#x000A;  Finished in 0.045543 seconds.&#x000A;&#x000A;    1) Failure:&#x000A;  test_should_be_using_rails_made_up_tag(RailsVersionTest)&#x000A;      [test/unit/rails_version_test.rb:6:in `test_should_be_using_rails_made_up_tag'&#x000A;       /path/to/code/rails_timestamps_test/projects/rails-app-made-up-tag/vendor/rails/activesupport/lib/active_support/testing/setup_and_teardown.rb:94:in `__send__'&#x000A;       /path/to/code/rails_timestamps_test/projects/rails-app-made-up-tag/vendor/rails/activesupport/lib/active_support/testing/setup_and_teardown.rb:94:in `run']:&#x000A;  &lt;"made.up.tag"&gt; expected but was&#x000A;  &lt;"2.2.2"&gt;.&#x000A;&#x000A;  1 tests, 1 assertions, 1 failures, 0 errors</pre>
        <ul>
        	<li>If you specify a tag of rails that is anything other than a 3 part version number (e.g. the four part version 2.3.2.1, or the release candidate 2.1.0_RC1) then the version test will fail because the Rails::<span class="caps">VERSION</span> constant only contains the <span class="caps">MAJOR</span>, <span class="caps">MINOR</span> and <span class="caps">TINY</span> components and that&#8217;s what we use to check the version our app uses.</li>
        </ul>
        <ul>
        	<li>The supplied database.yml file assumes a mysql database running on localhost that has a root user with no password.  You can update this to reflect your actual environment.</li>
        </ul>
        <ul>
        	<li>The projects are created in /path/to/code/rails_timestamps_test/projects/ with a name like rails-app-x-x-x (major, minor, tiny).</li>
        </ul>
        <ul>
        	<li>In order to ensure we are testing against the correct version of rails, I symlink rails from /path/to/code/rails (after changing to the requested tag) into rails-app-x-x-x/vendor/rails.  The problem here is that if you re-run the script with a different rails version and then attempt to run a test from your first project that it will be using the recently specified version of rails.  Luckily, the rails_version_test will fail fast which means you shouldn&#8217;t have to waste time wondering why something is not working as expected.</li>
        </ul>
        <ul>
        	<li>I wonder whether it&#8217;d be useful to extract the &#8216;create a rails app from a specific version of rails&#8217; functionality out of this script?</li>
        </ul>
        <p class="footnote" id="fn1"><a href="#fnr1"><sup>1</sup></a> <a href="http://www.eribium.org/">Alex MacCaw</a> <a href="http://www.madebymany.co.uk/a-rails-security-flaw-destroying-the-audit-trail-00820">raised the issue</a> in reference to number eight in the list of <a href="http://railspikes.com/2009/3/30/10-cool-things-in-rails-23">10 cools things in Rails 2.3</a>.</p>
        <hr />
        <ul class="navigation group">
          <li class="previousPost">
            &laquo; (older)
            <a class="previousPost" href="/blog/2009-04-14-generating-and-inserting-a-rel=canonical-link-into-pages-with-firefox-and-greasemonkey" rel="prev" title="Generating and Inserting a Rel=Canonical Link Into Pages With Firefox and Greasemonkey">
              Generating and Inserting a Rel=Canonical Link Into Pages With Firefox and Greasemonkey
            </a>
          </li>
          <li class="nextPost">
            <a class="nextPost" href="/blog/2009-04-24-a-greasemonkey-script-that-inserts-a-google-site-search-form-into-every-page" rel="next" title="A Greasemonkey Script that inserts a Google Site Search form into every page">
              A Greasemonkey Script that inserts a Google Site Search form into every page
            </a>
            (newer) &raquo;
          </li>
        </ul>
      </div>
      <div id="footer">
        <p class="license">
          <a href="http://creativecommons.org/licenses/by/2.0/uk/" rel="license">
            <img alt="Creative Commons License" src="http://i.creativecommons.org/l/by/2.0/uk/80x15.png" style="border-width:0" />
          </a>
          <span href="http://purl.org/dc/dcmitype/Text" property="dc:title" rel="dc:type" xmlns:dc="http://purl.org/dc/elements/1.1/">deferred until inspiration hits</span>
          by
          <span class="vcard">
            <a class="url fn" href="/contact" property="cc:attributionName" rel="cc:attributionURL" xmlns:cc="http://creativecommons.org/ns#">Chris Roos</a>
          </span>
          is licensed under a
          <a href="http://creativecommons.org/licenses/by/2.0/uk/" rel="license">Creative Commons Attribution 2.0 UK: England &amp; Wales License</a>
        </p>
      </div>
    </div>
    <script charset="utf-8" src="/javascripts/google-custom-search.js" type="text/javascript"></script>
  </body>
</html>
